{% extends "base.html" %}

{% block title %}ErntedankSequenzer - Editor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-edit"></i>
                    <span id="editor-title">
                        {% if sequence_name %}
                            Edit Sequence: {{ sequence_name }}
                        {% else %}
                            New Sequence
                        {% endif %}
                    </span>
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="validateSequence()">
                        <i class="fas fa-check"></i> Validate
                    </button>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form id="sequence-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="sequence-name" class="form-label">Sequence Name</label>
                            <input type="text" class="form-control" id="sequence-name"
                                   value="{{ sequence_name or '' }}" placeholder="Enter sequence name"
                                   pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, hyphens and underscores allowed">
                            <div class="form-text">Only letters, numbers, hyphens and underscores allowed</div>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="button" class="btn btn-success me-2" onclick="saveSequence()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button type="button" class="btn btn-primary me-2" onclick="saveAndRun()">
                                <i class="fas fa-play"></i> Save & Run
                            </button>
                            <button type="button" class="btn btn-warning" onclick="clearEditor()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="sequence-code" class="form-label">Sequence Code</label>
                        <textarea id="sequence-code" name="sequence">{{ sequence_code or '' }}</textarea>
                    </div>
                </form>

                <!-- Validation Results -->
                <div id="validation-results" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-clipboard-check"></i> Validation Results
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="validation-errors" style="display: none;">
                                <h6 class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i> Errors
                                </h6>
                                <ul id="error-list" class="list-unstyled"></ul>
                            </div>
                            <div id="validation-warnings" style="display: none;">
                                <h6 class="text-warning">
                                    <i class="fas fa-exclamation-circle"></i> Warnings
                                </h6>
                                <ul id="warning-list" class="list-unstyled"></ul>
                            </div>
                            <div id="validation-success" style="display: none;">
                                <div class="text-success">
                                    <i class="fas fa-check-circle"></i> Sequence is valid!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Function Reference -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-book"></i> Function Reference
                </h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="functionAccordion">
                    <!-- DMX Function -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#dmx-collapse">
                                <strong>write_dmx(address, value)</strong>
                            </button>
                        </h2>
                        <div id="dmx-collapse" class="accordion-collapse collapse"
                             data-bs-parent="#functionAccordion">
                            <div class="accordion-body">
                                <p><strong>Description:</strong> Send DMX value to specified channel</p>
                                <p><strong>Parameters:</strong></p>
                                <ul>
                                    <li><code>address</code>: DMX channel (1-512)</li>
                                    <li><code>value</code>: DMX value (0-255)</li>
                                </ul>
                                <p><strong>Example:</strong></p>
                                <code>write_dmx(1, 255)  # Channel 1 full brightness</code>
                            </div>
                        </div>
                    </div>

                    <!-- Sleep Function -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#sleep-collapse">
                                <strong>sleep(seconds)</strong>
                            </button>
                        </h2>
                        <div id="sleep-collapse" class="accordion-collapse collapse"
                             data-bs-parent="#functionAccordion">
                            <div class="accordion-body">
                                <p><strong>Description:</strong> Pause execution for specified time</p>
                                <p><strong>Parameters:</strong></p>
                                <ul>
                                    <li><code>seconds</code>: Time to wait (float/int)</li>
                                </ul>
                                <p><strong>Examples:</strong></p>
                                <code>sleep(2)    # Wait 2 seconds<br>
                                sleep(0.5)  # Wait 500ms</code>
                            </div>
                        </div>
                    </div>

                    <!-- Sound Function -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#sound-collapse">
                                <strong>play_sound(file, volume)</strong>
                            </button>
                        </h2>
                        <div id="sound-collapse" class="accordion-collapse collapse"
                             data-bs-parent="#functionAccordion">
                            <div class="accordion-body">
                                <p><strong>Description:</strong> Play audio file</p>
                                <p><strong>Parameters:</strong></p>
                                <ul>
                                    <li><code>file</code>: Sound filename (string)</li>
                                    <li><code>volume</code>: Volume level (0.0-1.0, optional)</li>
                                </ul>
                                <p><strong>Examples:</strong></p>
                                <code>play_sound('music.mp3')<br>
                                play_sound('effect.wav', 0.7)</code>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Functions -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#other-collapse">
                                <strong>Other Functions</strong>
                            </button>
                        </h2>
                        <div id="other-collapse" class="accordion-collapse collapse"
                             data-bs-parent="#functionAccordion">
                            <div class="accordion-body">
                                <p><strong>wait_for_sound()</strong><br>
                                Wait for current sound to finish playing</p>

                                <p><strong>stop_sound()</strong><br>
                                Stop currently playing sound</p>

                                <p><strong>Examples:</strong></p>
                                <code>play_sound('music.mp3')<br>
                                write_dmx(1, 255)<br>
                                wait_for_sound()  # Wait for music to end<br>
                                write_dmx(1, 0)</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Examples -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb"></i> Examples
                </h5>
            </div>
            <div class="card-body">
                {% for name, code in examples.items() %}
                <div class="mb-2">
                    <button class="btn btn-outline-info btn-sm w-100" onclick="loadExample('{{ name }}')">
                        <i class="fas fa-code"></i> {{ name.replace('_', ' ').title() }}
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Action Log -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-stream"></i> Action Log
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-secondary" onclick="toggleActionLog()" id="toggle-log-btn">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button class="btn btn-outline-danger" onclick="clearActionLog()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="action-log" class="action-log-compact">
                    <div class="p-2 text-muted text-center small">
                        <i class="fas fa-info-circle"></i> Action log will appear here
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let codeEditor;
let currentSequenceName = '{{ sequence_name or "" }}';

// Initialize CodeMirror
$(document).ready(function() {
    codeEditor = CodeMirror.fromTextArea(document.getElementById('sequence-code'), {
        mode: 'python',
        theme: 'monokai',
        lineNumbers: true,
        indentUnit: 4,
        lineWrapping: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        extraKeys: {
            'Ctrl-S': function() { saveSequence(); },
            'F5': function() { saveAndRun(); },
            'Ctrl-Enter': function() { validateSequence(); }
        }
    });

    // Load example if requested
    const urlParams = new URLSearchParams(window.location.search);
    const exampleName = urlParams.get('example');
    if (exampleName) {
        loadExampleByName(exampleName);
    }

    // Auto-validate on code change (debounced)
    let validationTimeout;
    codeEditor.on('change', function() {
        clearTimeout(validationTimeout);
        validationTimeout = setTimeout(function() {
            if (codeEditor.getValue().trim()) {
                validateSequence(true); // Silent validation
            }
        }, 1000);
    });
});

function validateSequence(silent = false) {
    const code = codeEditor.getValue();

    if (!code.trim()) {
        if (!silent) {
            showFlashMessage('Please enter some sequence code first', 'warning');
        }
        return;
    }

    $.ajax({
        url: '/api/validate',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            sequence: code
        }),
        dataType: 'json'
    })
    .done(function(data) {
        displayValidationResults(data, silent);
    })
    .fail(function() {
        if (!silent) {
            showFlashMessage('Validation failed', 'danger');
        }
    });
}

function displayValidationResults(data, silent = false) {
    const resultsDiv = $('#validation-results');
    const errorsDiv = $('#validation-errors');
    const warningsDiv = $('#validation-warnings');
    const successDiv = $('#validation-success');
    const errorList = $('#error-list');
    const warningList = $('#warning-list');

    // Clear previous results
    errorsDiv.hide();
    warningsDiv.hide();
    successDiv.hide();
    errorList.empty();
    warningList.empty();

    if (data.errors && data.errors.length > 0) {
        data.errors.forEach(function(error) {
            errorList.append(`<li class="text-danger"><i class="fas fa-times-circle"></i> ${error}</li>`);
        });
        errorsDiv.show();
        if (!silent) {
            showFlashMessage(`Validation failed with ${data.errors.length} error(s)`, 'danger');
        }
    }

    if (data.warnings && data.warnings.length > 0) {
        data.warnings.forEach(function(warning) {
            warningList.append(`<li class="text-warning"><i class="fas fa-exclamation-triangle"></i> ${warning}</li>`);
        });
        warningsDiv.show();
    }

    if (data.valid) {
        successDiv.show();
        if (!silent) {
            const warningCount = data.warnings ? data.warnings.length : 0;
            const message = warningCount > 0
                ? `Validation passed with ${warningCount} warning(s)`
                : 'Sequence is valid!';
            showFlashMessage(message, warningCount > 0 ? 'warning' : 'success');
        }
    }

    resultsDiv.show();
}

function saveSequence() {
    const name = $('#sequence-name').val().trim();
    const code = codeEditor.getValue();

    if (!name) {
        showFlashMessage('Please enter a sequence name', 'warning');
        $('#sequence-name').focus();
        return;
    }

    if (!code.trim()) {
        showFlashMessage('Please enter some sequence code', 'warning');
        codeEditor.focus();
        return;
    }

    const saveBtn = event.target;
    const originalContent = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    $.ajax({
        url: '/api/save',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            name: name,
            sequence: code
        }),
        dataType: 'json'
    })
    .done(function(data) {
        if (data.success) {
            showFlashMessage(data.message, 'success');
            currentSequenceName = name;
            $('#editor-title').text(`Edit Sequence: ${name}`);

            // Show warnings if any
            if (data.warnings && data.warnings.length > 0) {
                data.warnings.forEach(function(warning) {
                    showFlashMessage(warning, 'warning');
                });
            }
        } else {
            showFlashMessage(data.error || 'Failed to save sequence', 'danger');
            if (data.errors) {
                data.errors.forEach(function(error) {
                    showFlashMessage(error, 'danger');
                });
            }
        }
    })
    .fail(function(xhr) {
        const error = xhr.responseJSON?.error || 'Failed to save sequence';
        showFlashMessage(error, 'danger');
    })
    .always(function() {
        saveBtn.innerHTML = originalContent;
        saveBtn.disabled = false;
    });
}

function saveAndRun() {
    const name = $('#sequence-name').val().trim();
    const code = codeEditor.getValue();

    if (!name || !code.trim()) {
        saveSequence(); // This will show appropriate error messages
        return;
    }

    // First save the sequence
    $.ajax({
        url: '/api/save',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            name: name,
            sequence: code
        }),
        dataType: 'json'
    })
    .done(function(data) {
        if (data.success) {
            showFlashMessage('Sequence saved successfully', 'success');
            currentSequenceName = name;
            $('#editor-title').text(`Edit Sequence: ${name}`);

            // Then run it
            $.get(`/api/control/run/${name}`)
                .done(function(runData) {
                    if (runData.success) {
                        showFlashMessage(runData.message, 'success');
                    } else {
                        showFlashMessage(runData.error || 'Failed to run sequence', 'danger');
                    }
                })
                .fail(function(xhr) {
                    const error = xhr.responseJSON?.error || 'Failed to run sequence';
                    showFlashMessage(error, 'danger');
                });
        } else {
            showFlashMessage(data.error || 'Failed to save sequence', 'danger');
        }
    })
    .fail(function(xhr) {
        const error = xhr.responseJSON?.error || 'Failed to save sequence';
        showFlashMessage(error, 'danger');
    });
}

function clearEditor() {
    if (confirm('Are you sure you want to clear the editor? This will remove all unsaved changes.')) {
        codeEditor.setValue('');
        $('#sequence-name').val('');
        $('#validation-results').hide();
        currentSequenceName = '';
        $('#editor-title').text('New Sequence');
    }
}

function loadExample(exampleName) {
    $.get('/api/examples')
        .done(function(data) {
            if (data.success && data.examples[exampleName]) {
                if (codeEditor.getValue().trim() &&
                    !confirm('This will replace the current code. Are you sure?')) {
                    return;
                }

                codeEditor.setValue(data.examples[exampleName]);
                $('#sequence-name').val(exampleName);
                showFlashMessage(`Loaded example: ${exampleName.replace('_', ' ')}`, 'info');

                // Auto-validate the example
                setTimeout(function() {
                    validateSequence();
                }, 500);
            }
        })
        .fail(function() {
            showFlashMessage('Failed to load example', 'danger');
        });
}

function loadExampleByName(exampleName) {
    $.get('/api/examples')
        .done(function(data) {
            if (data.success && data.examples[exampleName]) {
                codeEditor.setValue(data.examples[exampleName]);
                $('#sequence-name').val(exampleName);
                showFlashMessage(`Loaded example: ${exampleName.replace('_', ' ')}`, 'info');
            }
        });
}

// Keyboard shortcuts info
// Action log functionality (compact version for editor)
let actionLogPaused = false;
let eventSource = null;

function initActionLog() {
    if (eventSource) {
        eventSource.close();
    }

    eventSource = new EventSource('/api/feedback/stream');

    eventSource.onmessage = function(event) {
        if (actionLogPaused) return;

        try {
            const action = JSON.parse(event.data);
            addActionToLog(action);
        } catch (e) {
            console.error('Error parsing action data:', e);
        }
    };

    eventSource.onerror = function(event) {
        console.error('Action log stream error:', event);
        setTimeout(() => {
            if (!actionLogPaused) {
                initActionLog();
            }
        }, 5000);
    };
}

function addActionToLog(action) {
    const logContainer = $('#action-log');
    const timestamp = new Date(action.timestamp).toLocaleTimeString();

    // Remove placeholder text if present
    if (logContainer.find('.text-muted.text-center').length) {
        logContainer.empty();
    }

    // Determine icon and color based on action type
    let icon, colorClass;
    switch (action.type) {
        case 'dmx':
            icon = 'fa-lightbulb';
            colorClass = 'text-warning';
            break;
        case 'sound':
            icon = 'fa-volume-up';
            colorClass = 'text-info';
            break;
        case 'sleep':
            icon = 'fa-clock';
            colorClass = 'text-secondary';
            break;
        case 'loop':
            icon = 'fa-repeat';
            colorClass = 'text-success';
            break;
        case 'sequence':
            icon = 'fa-play';
            colorClass = 'text-primary';
            break;
        case 'system':
            icon = 'fa-cog';
            colorClass = 'text-info';
            break;
        case 'error':
            icon = 'fa-exclamation-triangle';
            colorClass = 'text-danger';
            break;
        default:
            icon = 'fa-info-circle';
            colorClass = 'text-muted';
    }

    const logEntry = $(`
        <div class="action-entry-compact border-bottom">
            <div class="d-flex align-items-center px-2 py-1">
                <div class="flex-shrink-0 me-2">
                    <i class="fas ${icon} ${colorClass} fa-sm"></i>
                </div>
                <div class="flex-grow-1 text-truncate">
                    <div class="action-message-compact small">${action.message}</div>
                </div>
                <div class="flex-shrink-0 ms-2">
                    <small class="text-muted">${timestamp}</small>
                </div>
            </div>
        </div>
    `);

    logContainer.prepend(logEntry);

    // Keep only last 30 entries
    const entries = logContainer.find('.action-entry-compact');
    if (entries.length > 30) {
        entries.slice(30).remove();
    }

    // Auto-scroll to top for new entries
    logContainer.scrollTop(0);
}

function toggleActionLog() {
    actionLogPaused = !actionLogPaused;
    const btn = $('#toggle-log-btn');

    if (actionLogPaused) {
        btn.html('<i class="fas fa-play"></i> Resume');
        btn.removeClass('btn-outline-secondary').addClass('btn-outline-success');
        if (eventSource) {
            eventSource.close();
        }
    } else {
        btn.html('<i class="fas fa-pause"></i> Pause');
        btn.removeClass('btn-outline-success').addClass('btn-outline-secondary');
        initActionLog();
    }
}

function clearActionLog() {
    if (!confirm('Are you sure you want to clear the action log?')) {
        return;
    }

    $.post('/api/feedback/clear')
        .done(function(data) {
            if (data.success) {
                $('#action-log').html(`
                    <div class="p-2 text-muted text-center small">
                        <i class="fas fa-info-circle"></i> Action log cleared
                    </div>
                `);
                showFlashMessage('Action log cleared', 'success');
            } else {
                showFlashMessage(data.error || 'Failed to clear action log', 'danger');
            }
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to clear action log';
            showFlashMessage(error, 'danger');
        });
}

// Load initial actions
function loadInitialActions() {
    $.get('/api/feedback/actions?limit=10')
        .done(function(data) {
            if (data.success && data.actions.length > 0) {
                const logContainer = $('#action-log');
                logContainer.empty();

                data.actions.reverse().forEach(action => {
                    addActionToLog(action);
                });
            }
        })
        .fail(function(xhr) {
            console.error('Failed to load initial actions:', xhr);
        });
}

$(document).ready(function() {
    showFlashMessage('Tip: Use Ctrl+S to save, F5 to save & run, Ctrl+Enter to validate', 'info');
    loadInitialActions();
    initActionLog();
});

// Clean up event source when page unloads
$(window).on('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
});
</script>

<style>
.action-log-compact {
    height: 200px;
    overflow-y: auto;
    background-color: #1a1a1a;
    border: 1px solid #404040;
}

.action-entry-compact {
    border-bottom: 1px solid #2d2d2d !important;
    transition: background-color 0.2s;
}

.action-entry-compact:hover {
    background-color: #2d2d2d;
}

.action-entry-compact:last-child {
    border-bottom: none !important;
}

.action-message-compact {
    color: #ffffff;
    font-size: 0.8rem;
}

.action-log-compact::-webkit-scrollbar {
    width: 4px;
}

.action-log-compact::-webkit-scrollbar-track {
    background: #1a1a1a;
}

.action-log-compact::-webkit-scrollbar-thumb {
    background: #404040;
    border-radius: 2px;
}

.action-log-compact::-webkit-scrollbar-thumb:hover {
    background: #555555;
}
</style>
{% endblock %}
